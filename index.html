<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="Mzr96mfBDF5lEjVKgbSI06nvTyImjwbDyoGGz-nGoGo" />
    <title>Sistem Manajemen Desa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        .nav-item.active {
            background-color: #4a5568; /* Tailwind's gray-700 */
            color: #ffffff; /* Tailwind's white */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col font-inter">

    <div id="login-screen" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center relative">
            <button onclick="closeLoginScreen()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button>
            <i class="fa-solid fa-user-shield text-6xl text-indigo-600 mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Login Admin</h2>
            <p class="text-gray-500 mb-6">Masukkan kata sandi admin untuk melanjutkan.</p>
            <div class="space-y-4">
                <input type="password" id="adminPasswordInput" placeholder="Kata Sandi Admin" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button onclick="loginAdmin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    Masuk
                </button>
            </div>
            <p id="login-error" class="text-red-500 mt-4 hidden">Kata sandi salah!</p>
        </div>
    </div>

    <div id="app-interface" class="flex-1 flex h-screen overflow-hidden">
        <aside class="w-64 bg-gray-800 text-gray-100 flex flex-col p-4">
            <div class="flex items-center space-x-2 pb-4 mb-4 border-b border-gray-700">
                <i class="fa-solid fa-house-chimney-user text-3xl text-indigo-400"></i>
                <h1 class="text-2xl font-bold">SIDeM</h1>
            </div>
            <nav class="flex-1 space-y-2">
                <button id="navDashboard" onclick="changeView('dashboard')" class="w-full text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-700 transition flex items-center space-x-3 nav-item">
                    <i class="fa-solid fa-chart-line w-5"></i><span>Dashboard</span>
                </button>
                <button id="navPopulation" onclick="changeView('population')" class="w-full text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-700 transition flex items-center space-x-3 nav-item">
                    <i class="fa-solid fa-users w-5"></i><span>Penduduk</span>
                </button>
                <button id="navAssets" onclick="changeView('assets')" class="w-full text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-700 transition flex items-center space-x-3 nav-item">
                    <i class="fa-solid fa-building-flag w-5"></i><span>Aset Desa</span>
                </button>
                <button id="navDevelopment" onclick="changeView('development')" class="w-full text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-700 transition flex items-center space-x-3 nav-item">
                    <i class="fa-solid fa-road w-5"></i><span>Pembangunan</span>
                </button>
                <button id="navFinances" onclick="changeView('finances')" class="w-full text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-700 transition flex items-center space-x-3 nav-item">
                    <i class="fa-solid fa-coins w-5"></i><span>Keuangan</span>
                </button>
                <button id="navBansos" onclick="changeView('bansos')" class="w-full text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-700 transition flex items-center space-x-3 nav-item">
                    <i class="fa-solid fa-hand-holding-heart w-5"></i><span>Bantuan Sosial</span>
                </button>
                <button id="navComplaints" onclick="changeView('complaints')" class="w-full text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-700 transition flex items-center space-x-3 nav-item">
                    <i class="fa-solid fa-comments w-5"></i><span>Pengaduan</span>
                </button>
                <button id="navActivityLogs" onclick="changeView('activityLogs')" class="w-full text-left py-2 px-3 rounded-lg font-medium hover:bg-gray-700 transition flex items-center space-x-3 nav-item">
                    <i class="fa-solid fa-clipboard-list w-5"></i><span>Laporan Aktivitas</span>
                </button>
            </nav>
            <div class="pt-4 mt-4 border-t border-gray-700">
                <div class="flex items-center space-x-2 mb-2">
                    <p class="text-xs text-gray-400">Peran:</p>
                    <span id="currentRoleDisplay" class="text-sm font-semibold text-indigo-300 capitalize">Masyarakat Umum</span>
                </div>
                <div id="admin-login-logout-button">
                    </div>
            </div>
        </aside>

        <main class="flex-1 overflow-auto p-8">
            <div id="dashboard-content" class="content">
                <header class="pb-6 mb-6 border-b border-gray-300">
                    <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                </header>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="dashboard-cards">
                </div>
                <div class="card bg-white p-6 rounded-xl shadow-md mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Ringkasan Keuangan</h3>
                    <p class="text-2xl font-bold text-green-600 mb-2">Pemasukan: Rp <span id="pemasukan-total">0</span></p>
                    <p class="text-2xl font-bold text-red-600 mb-2">Pengeluaran: Rp <span id="pengeluaran-total">0</span></p>
                    <p class="text-2xl font-bold text-indigo-600">Saldo: Rp <span id="saldo-total">0</span></p>
                </div>
            </div>

            <div id="population-content" class="content hidden">
                <header class="pb-6 mb-6 border-b border-gray-300 flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800">Manajemen Data Penduduk</h2>
                    <div id="penduduk-admin-controls" class="hidden">
                        <button onclick="openPendudukModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition"><i class="fa-solid fa-plus mr-2"></i>Tambah Penduduk</button>
                    </div>
                </header>
                <div id="penduduk-table-container" class="overflow-x-auto bg-white rounded-xl shadow-md">
                </div>
            </div>

            <div id="assets-content" class="content hidden">
                <header class="pb-6 mb-6 border-b border-gray-300 flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800">Manajemen Aset Desa</h2>
                    <div id="aset-admin-controls" class="hidden">
                        <button onclick="openAsetModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition"><i class="fa-solid fa-plus mr-2"></i>Tambah Aset</button>
                    </div>
                </header>
                <div id="aset-table-container" class="overflow-x-auto bg-white rounded-xl shadow-md">
                </div>
            </div>

            <div id="development-content" class="content hidden">
                <header class="pb-6 mb-6 border-b border-gray-300 flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800">Manajemen Pembangunan</h2>
                    <div id="pembangunan-admin-controls" class="hidden">
                        <button onclick="openPembangunanModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition"><i class="fa-solid fa-plus mr-2"></i>Tambah Pembangunan</button>
                    </div>
                </header>
                <div id="pembangunan-table-container" class="overflow-x-auto bg-white rounded-xl shadow-md">
                </div>
            </div>
            
            <div id="finances-content" class="content hidden">
                <header class="pb-6 mb-6 border-b border-gray-300 flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800">Manajemen Keuangan</h2>
                    <div id="keuangan-admin-controls" class="hidden">
                        <button onclick="openKeuanganModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition"><i class="fa-solid fa-plus mr-2"></i>Tambah Transaksi</button>
                    </div>
                </header>
                <div id="keuangan-table-container" class="overflow-x-auto bg-white rounded-xl shadow-md">
                </div>
            </div>
            
            <div id="bansos-content" class="content hidden">
                <header class="pb-6 mb-6 border-b border-gray-300 flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800">Manajemen Bantuan Sosial</h2>
                    <div id="bansos-admin-controls" class="hidden">
                        <button onclick="openBansosModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition"><i class="fa-solid fa-plus mr-2"></i>Tambah Bantuan</button>
                    </div>
                </header>
                <div id="bansos-table-container" class="overflow-x-auto bg-white rounded-xl shadow-md">
                </div>
            </div>
            
            <div id="complaints-content" class="content hidden">
                <header class="pb-6 mb-6 border-b border-gray-300 flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800">Manajemen Pengaduan</h2>
                    <div id="pengaduan-admin-controls" class="hidden">
                        <button onclick="openPengaduanModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition"><i class="fa-solid fa-plus mr-2"></i>Tambah Pengaduan</button>
                    </div>
                </header>
                <div id="pengaduan-table-container" class="overflow-x-auto bg-white rounded-xl shadow-md">
                </div>
            </div>

            <div id="activityLogs-content" class="content hidden">
                <header class="pb-6 mb-6 border-b border-gray-300">
                    <h2 class="text-3xl font-bold text-gray-800">Laporan Aktivitas Sistem</h2>
                </header>
                <div class="filter-section bg-white p-6 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="logStartDate" class="block text-sm font-medium text-gray-700">Dari Tanggal:</label>
                            <input type="date" id="logStartDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="logEndDate" class="block text-sm font-medium text-gray-700">Sampai Tanggal:</label>
                            <input type="date" id="logEndDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="logUserFilter" class="block text-sm font-medium text-gray-700">Pengguna:</label>
                            <select id="logUserFilter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Semua Pengguna</option>
                                <option value="admin_desa">admin_desa</option>
                                <option value="guest">guest</option>
                            </select>
                        </div>
                        <div>
                            <label for="logModuleFilter" class="block text-sm font-medium text-gray-700">Modul:</label>
                            <select id="logModuleFilter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Semua Modul</option>
                                <option value="Penduduk">Penduduk</option>
                                <option value="Aset Desa">Aset Desa</option>
                                <option value="Pembangunan">Pembangunan</option>
                                <option value="Keuangan">Keuangan</option>
                                <option value="Bantuan Sosial">Bantuan Sosial</option>
                                <option value="Pengaduan">Pengaduan</option>
                                <option value="Sistem">Sistem</option>
                            </select>
                        </div>
                        <div>
                            <label for="logActionTypeFilter" class="block text-sm font-medium text-gray-700">Tipe Aksi:</label>
                            <select id="logActionTypeFilter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="">Semua Aksi</option>
                                <option value="CREATE">CREATE</option>
                                <option value="UPDATE">UPDATE</option>
                                <option value="DELETE">DELETE</option>
                                <option value="VIEW">VIEW</option>
                                <option value="LOGIN">LOGIN</option>
                                <option value="LOGOUT">LOGOUT</option>
                            </select>
                        </div>
                        <div>
                            <label for="logSearchText" class="block text-sm font-medium text-gray-700">Cari Teks:</label>
                            <input type="text" id="logSearchText" placeholder="Deskripsi, ID, dll." class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="applyLogFilters()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition"><i class="fa-solid fa-filter mr-2"></i>Terapkan Filter</button>
                        <button onclick="exportActivityLogsToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition"><i class="fa-solid fa-file-excel mr-2"></i>Export ke Excel</button>
                    </div>
                </div>
                
                <div id="log-table-container" class="overflow-x-auto bg-white rounded-xl shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pengguna</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modul</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Record</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detail</th>
                            </tr>
                        </thead>
                        <tbody id="activityLogsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="pendudukModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="pendudukModalTitle" class="text-xl font-bold text-gray-800">Tambah Penduduk</h3>
                <button onclick="closePendudukModal()" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <form id="pendudukForm" class="space-y-4">
                <input type="hidden" id="pendudukId">
                <input type="text" id="nik" placeholder="NIK" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="kk" placeholder="Nomor KK" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="nama" placeholder="Nama Lengkap" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="number" id="usia" placeholder="Usia" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="pekerjaan" placeholder="Pekerjaan" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="pendidikan" placeholder="Pendidikan" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="status_kawin" placeholder="Status Perkawinan" required class="w-full p-2 border border-gray-300 rounded-lg">
                <textarea id="riwayat_domisili" placeholder="Riwayat Domisili" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" onclick="closePendudukModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Batal</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="asetModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="asetModalTitle" class="text-xl font-bold text-gray-800">Tambah Aset</h3>
                <button onclick="closeAsetModal()" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <form id="asetForm" class="space-y-4">
                <input type="hidden" id="asetId">
                <input type="text" id="nama_aset" placeholder="Nama Aset" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="number" id="jumlah" placeholder="Jumlah" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="kondisi" placeholder="Kondisi (Baik/Rusak)" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="lokasi" placeholder="Lokasi Aset" required class="w-full p-2 border border-gray-300 rounded-lg">
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" onclick="closeAsetModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Batal</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="pembangunanModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="pembangunanModalTitle" class="text-xl font-bold text-gray-800">Tambah Pembangunan</h3>
                <button onclick="closePembangunanModal()" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <form id="pembangunanForm" class="space-y-4">
                <input type="hidden" id="pembangunanId">
                <input type="text" id="pembangunanNama" placeholder="Nama Proyek" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="pembangunanStatus" placeholder="Status (Proses/Selesai)" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="number" id="pembangunanAnggaran" placeholder="Anggaran" required class="w-full p-2 border border-gray-300 rounded-lg">
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" onclick="closePembangunanModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Batal</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="keuanganModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="keuanganModalTitle" class="text-xl font-bold text-gray-800">Tambah Transaksi</h3>
                <button onclick="closeKeuanganModal()" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <form id="keuanganForm" class="space-y-4">
                <input type="hidden" id="keuanganId">
                <select id="keuanganTipe" required class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="">Pilih Tipe</option>
                    <option value="pemasukan">Pemasukan</option>
                    <option value="pengeluaran">Pengeluaran</option>
                </select>
                <input type="text" id="keuanganDeskripsi" placeholder="Deskripsi" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="number" id="keuanganJumlah" placeholder="Jumlah" required class="w-full p-2 border border-gray-300 rounded-lg">
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" onclick="closeKeuanganModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Batal</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bansosModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="bansosModalTitle" class="text-xl font-bold text-gray-800">Tambah Bantuan</h3>
                <button onclick="closeBansosModal()" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <form id="bansosForm" class="space-y-4">
                <input type="hidden" id="bansosId">
                <select id="bansosNamaPenerima" required class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="">Pilih Nama Penerima</option>
                    </select>
                <input type="text" id="bansosJenis" placeholder="Jenis Bantuan" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="bansosStatus" placeholder="Status (Diajukan/Diterima/Ditolak)" required class="w-full p-2 border border-gray-300 rounded-lg">
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" onclick="closeBansosModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Batal</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="pengaduanModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 id="pengaduanModalTitle" class="text-xl font-bold text-gray-800">Tambah Pengaduan</h3>
                <button onclick="closePengaduanModal()" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <form id="pengaduanForm" class="space-y-4">
                <input type="hidden" id="pengaduanId">
                <input type="text" id="pengaduanNamaPelapor" placeholder="Nama Pelapor" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="pengaduanJudul" placeholder="Judul Pengaduan" required class="w-full p-2 border border-gray-300 rounded-lg">
                <textarea id="pengaduanDeskripsi" placeholder="Deskripsi" required class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                <select id="pengaduanStatus" required class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="Diajukan">Diajukan</option>
                    <option value="Proses">Proses</option>
                    <option value="Selesai">Selesai</option>
                </select>
                <div class="mt-6 flex justify-end space-x-2">
                    <button type="button" onclick="closePengaduanModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Batal</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirmationModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Konfirmasi</h3>
            <p class="text-gray-600 mb-6" id="confirmationMessage">Apakah Anda yakin ingin menghapus data ini?</p>
            <div class="flex justify-center space-x-4">
                <button onclick="performDeletion()" class="bg-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-red-700 transition">Ya</button>
                <button onclick="closeConfirmationModal()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-semibold hover:bg-gray-300 transition">Tidak</button>
            </div>
        </div>
    </div>

    <div id="logDetailModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Detail Aktivitas Log</h3>
                <button onclick="closeLogDetailModal()" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <pre id="logDetailContent" class="bg-gray-100 p-4 rounded-md text-sm overflow-x-auto whitespace-pre-wrap"></pre>
        </div>
    </div>
    
    <div id="hidden-login-button-container" class="fixed bottom-4 right-4 z-50">
        <button onclick="openLoginScreen()" class="bg-gray-400 text-white px-2 py-1 rounded-full text-xs opacity-0 hover:opacity-100 transition-opacity duration-300">
            Login
        </button>
    </div>

    <script>
        // =======================================================
        // STATE DAN DATA LOKAL (PENGGANTI DATABASE)
        // =======================================================
        
        // Objek state pusat untuk mengelola status aplikasi
        const state = {
            userRole: 'guest',
            currentView: 'dashboard',
            pendudukData: JSON.parse(localStorage.getItem('pendudukData')) || [
                { id: '1', nik: '1234567890123456', kk: '1234567890', nama: 'Budi Santoso', usia: 35, pekerjaan: 'Petani', pendidikan: 'SMA', status_kawin: 'Kawin', riwayat_domisili: 'Jl. Melati No. 1', tanggal: '2025-08-15T09:00:00Z' },
                { id: '2', nik: '6543210987654321', kk: '0987654321', nama: 'Siti Aminah', usia: 28, pekerjaan: 'Ibu Rumah Tangga', pendidikan: 'SMP', status_kawin: 'Kawin', riwayat_domisili: 'Jl. Kenanga No. 5', tanggal: '2025-08-16T10:30:00Z' },
                { id: '3', nik: '9876543210987654', kk: '1122334455', nama: 'Joko Prabowo', usia: 45, pekerjaan: 'Pedagang', pendidikan: 'SD', status_kawin: 'Kawin', riwayat_domisili: 'Jl. Mawar No. 3', tanggal: '2025-08-17T11:45:00Z' }
            ],
            asetData: JSON.parse(localStorage.getItem('asetData')) || [
                { id: '1', nama_aset: 'Motor Dinas', jumlah: 2, kondisi: 'Baik', lokasi: 'Kantor Desa', tanggal: '2025-08-16T08:00:00Z' },
                { id: '2', nama_aset: 'Laptop', jumlah: 5, kondisi: 'Baik', lokasi: 'Kantor Desa', tanggal: '2025-08-17T14:15:00Z' },
                { id: '3', nama_aset: 'Tractor', jumlah: 1, kondisi: 'Rusak', lokasi: 'Gudang', tanggal: '2025-08-18T16:00:00Z' },
            ],
            pembangunanData: JSON.parse(localStorage.getItem('pembangunanData')) || [
                { id: '1', nama_proyek: 'Perbaikan Jalan Raya', status: 'Proses', anggaran: 50000000, tanggal: '2025-07-20T07:00:00Z' },
                { id: '2', nama_proyek: 'Pembangunan Posyandu', status: 'Selesai', anggaran: 20000000, tanggal: '2025-08-01T12:00:00Z' },
            ],
            keuanganData: JSON.parse(localStorage.getItem('keuanganData')) || [
                { id: '1', tipe: 'pemasukan', deskripsi: 'Dana Desa Tahap 1', jumlah: 100000000, tanggal: '2025-08-10T11:00:00Z' },
                { id: '2', tipe: 'pengeluaran', deskripsi: 'Gaji Perangkat Desa', jumlah: 15000000, tanggal: '2025-08-11T13:00:00Z' },
                { id: '3', tipe: 'pemasukan', deskripsi: 'Pajak Bumi Bangunan', jumlah: 50000000, tanggal: '2025-08-12T09:30:00Z' },
                { id: '4', tipe: 'pengeluaran', deskripsi: 'Pembelian Aset', jumlah: 35000000, tanggal: '2025-08-13T10:00:00Z' },
            ],
            bansosData: JSON.parse(localStorage.getItem('bansosData')) || [
                { id: '1', recipientId: '2', jenis_bantuan: 'Beras', status: 'Diterima', tanggal: '2025-08-18T10:00:00Z' }, // Siti Aminah
                { id: '2', recipientId: '1', jenis_bantuan: 'Uang Tunai', status: 'Diajukan', tanggal: '2025-08-19T11:00:00Z' }, // Budi Santoso
            ],
            pengaduanData: JSON.parse(localStorage.getItem('pengaduanData')) || [
                { id: '1', nama_pelapor: 'Ahmad', judul: 'Jalan Rusak', deskripsi: 'Jalan di depan balai desa berlubang', status: 'Diajukan', tanggal: '2025-08-18T14:00:00Z' },
                { id: '2', nama_pelapor: 'Kartini', judul: 'Lampu Jalan Mati', deskripsi: 'Lampu di RW 02 mati total', status: 'Proses', tanggal: '2025-08-19T09:00:00Z' },
            ],
            activityLogs: JSON.parse(localStorage.getItem('activityLogs')) || [],
        };

        // =======================================================
        // HELPER FUNCTIONS
        // =======================================================

        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveState() {
            localStorage.setItem('pendudukData', JSON.stringify(state.pendudukData));
            localStorage.setItem('asetData', JSON.stringify(state.asetData));
            localStorage.setItem('pembangunanData', JSON.stringify(state.pembangunanData));
            localStorage.setItem('keuanganData', JSON.stringify(state.keuanganData));
            localStorage.setItem('bansosData', JSON.stringify(state.bansosData));
            localStorage.setItem('pengaduanData', JSON.stringify(state.pengaduanData));
            localStorage.setItem('activityLogs', JSON.stringify(state.activityLogs));
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', options);
        }

        function addActivityLog(module, action, recordId, description, status = 'SUCCESS', details = null) {
            const log = {
                id: generateId(),
                timestamp: new Date().toISOString(),
                user: state.userRole === 'admin' ? 'admin_desa' : 'guest',
                module: module,
                action: action,
                recordId: recordId,
                description: description,
                ipAddress: '127.0.0.1', // Placeholder
                status: status,
                details: details
            };
            state.activityLogs.push(log);
            saveState();
            renderActivityLogsTable();
        }
        
        function cleanUpOldLogs() {
            const oneMonthAgo = new Date();
            oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
            
            const initialLogCount = state.activityLogs.length;
            state.activityLogs = state.activityLogs.filter(log => {
                return new Date(log.timestamp) > oneMonthAgo;
            });

            if (state.activityLogs.length < initialLogCount) {
                saveState();
                console.log(`Pembersihan log otomatis: ${initialLogCount - state.activityLogs.length} log lama berhasil dihapus.`);
            }
        }

        // =======================================================
        // VIEW MANAGEMENT
        // =======================================================

        function changeView(view) {
            const contents = document.querySelectorAll('.content');
            contents.forEach(content => content.classList.add('hidden'));
            document.getElementById(`${view}-content`).classList.remove('hidden');

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            document.getElementById(`nav${capitalize(view)}`).classList.add('active');

            state.currentView = view;
            
            if (view === 'dashboard') {
                renderDashboard();
            } else if (view === 'population') {
                renderPendudukTable();
            } else if (view === 'assets') {
                renderAsetTable();
            } else if (view === 'development') {
                renderPembangunanTable();
            } else if (view === 'finances') {
                renderKeuanganTable();
            } else if (view === 'bansos') {
                renderBansosTable();
            } else if (view === 'complaints') {
                renderPengaduanTable();
            } else if (view === 'activityLogs') {
                renderActivityLogsTable();
            }
        }

        function capitalize(s) {
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        // =======================================================
        // ROLE MANAGEMENT & LOGIN/LOGOUT
        // =======================================================

        function updateRole(role) {
            state.userRole = role;
            document.getElementById('currentRoleDisplay').textContent = role === 'admin' ? 'Admin Desa' : 'Masyarakat Umum';
            updateAdminControls();
            updateLoginLogoutButton();
            changeView(state.currentView);
        }

        function updateAdminControls() {
            const controls = document.querySelectorAll('[id$="-admin-controls"]');
            controls.forEach(control => {
                if (state.userRole === 'admin') {
                    control.classList.remove('hidden');
                } else {
                    control.classList.add('hidden');
                }
            });
        }

        function updateLoginLogoutButton() {
            const buttonContainer = document.getElementById('admin-login-logout-button');
            const hiddenLoginButtonContainer = document.getElementById('hidden-login-button-container');
            if (state.userRole === 'admin') {
                buttonContainer.innerHTML = `<button onclick="logoutAdmin()" class="w-full bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 transition flex items-center justify-center space-x-2"><i class="fa-solid fa-sign-out-alt"></i><span>Keluar Admin</span></button>`;
                hiddenLoginButtonContainer.classList.add('hidden');
            } else {
                buttonContainer.innerHTML = '';
                hiddenLoginButtonContainer.classList.remove('hidden');
            }
        }

        function openLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function closeLoginScreen() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('adminPasswordInput').value = '';
            document.getElementById('login-error').classList.add('hidden');
        }

        function loginAdmin() {
            const password = document.getElementById('adminPasswordInput').value;
            const correctPassword = 'admin123';
            if (password === correctPassword) {
                updateRole('admin');
                closeLoginScreen();
                addActivityLog('Sistem', 'LOGIN', null, 'Admin berhasil login');
            } else {
                document.getElementById('login-error').classList.remove('hidden');
                addActivityLog('Sistem', 'LOGIN', null, 'Admin gagal login', 'FAILED');
            }
        }

        function logoutAdmin() {
            updateRole('guest');
            addActivityLog('Sistem', 'LOGOUT', null, 'Admin berhasil logout');
        }

        // =======================================================
        // DASHBOARD
        // =======================================================

        function renderDashboard() {
            const dashboardCards = document.getElementById('dashboard-cards');
            dashboardCards.innerHTML = '';
            
            const totalPenduduk = state.pendudukData.length;
            const totalAset = state.asetData.length;
            const totalPembangunanProses = state.pembangunanData.filter(p => p.status.toLowerCase() === 'proses').length;
            const totalPengaduanDiajukan = state.pengaduanData.filter(p => p.status.toLowerCase() === 'diajukan').length;
            const totalPengeluaran = state.keuanganData.filter(f => f.tipe === 'pengeluaran').reduce((sum, f) => sum + f.jumlah, 0);
            const totalPemasukan = state.keuanganData.filter(f => f.tipe === 'pemasukan').reduce((sum, f) => sum + f.jumlah, 0);
            const saldoAkhir = totalPemasukan - totalPengeluaran;

            const cards = [
                { title: 'Total Penduduk', value: totalPenduduk, icon: 'fa-users', color: 'indigo' },
                { title: 'Jumlah Aset', value: totalAset, icon: 'fa-building-flag', color: 'green' },
                { title: 'Proyek Berlangsung', value: totalPembangunanProses, icon: 'fa-helmet-safety', color: 'yellow' },
                { title: 'Pengaduan Baru', value: totalPengaduanDiajukan, icon: 'fa-bell', color: 'red' }
            ];

            cards.forEach(card => {
                const cardHtml = `
                    <div class="card bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                        <div class="bg-${card.color}-100 text-${card.color}-500 p-4 rounded-full">
                            <i class="fa-solid ${card.icon} fa-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">${card.title}</p>
                            <p class="text-3xl font-bold text-gray-800">${card.value}</p>
                        </div>
                    </div>
                `;
                dashboardCards.innerHTML += cardHtml;
            });
            
            document.getElementById('pemasukan-total').textContent = totalPemasukan.toLocaleString('id-ID');
            document.getElementById('pengeluaran-total').textContent = totalPengeluaran.toLocaleString('id-ID');
            document.getElementById('saldo-total').textContent = saldoAkhir.toLocaleString('id-ID');
        }

        // =======================================================
        // PENDUDUK
        // =======================================================

        function renderPendudukTable() {
            const tableContainer = document.getElementById('penduduk-table-container');
            if (state.pendudukData.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Belum ada data penduduk.</p>';
                return;
            }
            
            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIK</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usia</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pekerjaan</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            state.pendudukData.forEach(item => {
                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.tanggal)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nik}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.usia}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.pekerjaan}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewDetails('penduduk', '${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2"><i class="fa-solid fa-eye"></i></button>
                            <button onclick="editPenduduk('${item.id}')" class="text-yellow-600 hover:text-yellow-900 mr-2 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-edit"></i></button>
                            <button onclick="deleteItem('penduduk', '${item.id}')" class="text-red-600 hover:text-red-900 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            tableContainer.innerHTML = tableHtml;
        }

        function openPendudukModal(item = null) {
            if (state.userRole !== 'admin') return;
            const modal = document.getElementById('pendudukModal');
            const form = document.getElementById('pendudukForm');
            const title = document.getElementById('pendudukModalTitle');
            form.reset();
            document.getElementById('pendudukId').value = '';

            if (item) {
                title.textContent = 'Edit Penduduk';
                document.getElementById('pendudukId').value = item.id;
                document.getElementById('nik').value = item.nik;
                document.getElementById('kk').value = item.kk;
                document.getElementById('nama').value = item.nama;
                document.getElementById('usia').value = item.usia;
                document.getElementById('pekerjaan').value = item.pekerjaan;
                document.getElementById('pendidikan').value = item.pendidikan;
                document.getElementById('status_kawin').value = item.status_kawin;
                document.getElementById('riwayat_domisili').value = item.riwayat_domisili;
            } else {
                title.textContent = 'Tambah Penduduk';
            }
            modal.classList.add('active');
        }

        function closePendudukModal() {
            document.getElementById('pendudukModal').classList.remove('active');
        }

        document.getElementById('pendudukForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('pendudukId').value;
            const data = {
                nik: document.getElementById('nik').value,
                kk: document.getElementById('kk').value,
                nama: document.getElementById('nama').value,
                usia: parseInt(document.getElementById('usia').value),
                pekerjaan: document.getElementById('pekerjaan').value,
                pendidikan: document.getElementById('pendidikan').value,
                status_kawin: document.getElementById('status_kawin').value,
                riwayat_domisili: document.getElementById('riwayat_domisili').value,
            };
            savePenduduk(data, id);
        });

        function savePenduduk(data, id) {
            if (state.userRole !== 'admin') return;
            if (id) {
                const index = state.pendudukData.findIndex(item => item.id === id);
                if (index !== -1) {
                    const oldData = state.pendudukData[index];
                    state.pendudukData[index] = { ...oldData, ...data, tanggal: new Date().toISOString() };
                    addActivityLog('Penduduk', 'UPDATE', id, `Mengubah data penduduk: ${data.nama}`);
                }
            } else {
                const newId = generateId();
                const newData = { id: newId, ...data, tanggal: new Date().toISOString() };
                state.pendudukData.push(newData);
                addActivityLog('Penduduk', 'CREATE', newId, `Menambah penduduk baru: ${data.nama}`);
            }
            saveState();
            renderPendudukTable();
            closePendudukModal();
            renderDashboard();
        }

        function editPenduduk(id) {
            if (state.userRole !== 'admin') return;
            const item = state.pendudukData.find(item => item.id === id);
            if (item) {
                openPendudukModal(item);
            }
        }

        // =======================================================
        // ASET
        // =======================================================

        function renderAsetTable() {
            const tableContainer = document.getElementById('aset-table-container');
            if (state.asetData.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Belum ada data aset.</p>';
                return;
            }

            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Aset</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kondisi</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            state.asetData.forEach(item => {
                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.tanggal)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nama_aset}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.jumlah}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.kondisi}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.lokasi}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewDetails('aset', '${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2"><i class="fa-solid fa-eye"></i></button>
                            <button onclick="editAset('${item.id}')" class="text-yellow-600 hover:text-yellow-900 mr-2 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-edit"></i></button>
                            <button onclick="deleteItem('aset', '${item.id}')" class="text-red-600 hover:text-red-900 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            tableContainer.innerHTML = tableHtml;
        }

        function openAsetModal(item = null) {
            if (state.userRole !== 'admin') return;
            const modal = document.getElementById('asetModal');
            const form = document.getElementById('asetForm');
            const title = document.getElementById('asetModalTitle');
            form.reset();
            document.getElementById('asetId').value = '';

            if (item) {
                title.textContent = 'Edit Aset';
                document.getElementById('asetId').value = item.id;
                document.getElementById('nama_aset').value = item.nama_aset;
                document.getElementById('jumlah').value = item.jumlah;
                document.getElementById('kondisi').value = item.kondisi;
                document.getElementById('lokasi').value = item.lokasi;
            } else {
                title.textContent = 'Tambah Aset';
            }
            modal.classList.add('active');
        }

        function closeAsetModal() {
            document.getElementById('asetModal').classList.remove('active');
        }

        document.getElementById('asetForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('asetId').value;
            const data = {
                nama_aset: document.getElementById('nama_aset').value,
                jumlah: parseInt(document.getElementById('jumlah').value),
                kondisi: document.getElementById('kondisi').value,
                lokasi: document.getElementById('lokasi').value,
            };
            saveAset(data, id);
        });

        function saveAset(data, id) {
            if (state.userRole !== 'admin') return;
            if (id) {
                const index = state.asetData.findIndex(item => item.id === id);
                if (index !== -1) {
                    const oldData = state.asetData[index];
                    state.asetData[index] = { ...oldData, ...data, tanggal: new Date().toISOString() };
                    addActivityLog('Aset Desa', 'UPDATE', id, `Mengubah data aset: ${data.nama_aset}`);
                }
            } else {
                const newId = generateId();
                const newData = { id: newId, ...data, tanggal: new Date().toISOString() };
                state.asetData.push(newData);
                addActivityLog('Aset Desa', 'CREATE', newId, `Menambah aset baru: ${data.nama_aset}`);
            }
            saveState();
            renderAsetTable();
            closeAsetModal();
            renderDashboard();
        }

        function editAset(id) {
            if (state.userRole !== 'admin') return;
            const item = state.asetData.find(item => item.id === id);
            if (item) {
                openAsetModal(item);
            }
        }

        // =======================================================
        // PEMBANGUNAN
        // =======================================================

        function renderPembangunanTable() {
            const tableContainer = document.getElementById('pembangunan-table-container');
            if (state.pembangunanData.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Belum ada data pembangunan.</p>';
                return;
            }
            
            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Proyek</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Anggaran</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            state.pembangunanData.forEach(item => {
                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.tanggal)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nama_proyek}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.status}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">Rp ${item.anggaran.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewDetails('pembangunan', '${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2"><i class="fa-solid fa-eye"></i></button>
                            <button onclick="editPembangunan('${item.id}')" class="text-yellow-600 hover:text-yellow-900 mr-2 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-edit"></i></button>
                            <button onclick="deleteItem('pembangunan', '${item.id}')" class="text-red-600 hover:text-red-900 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            tableContainer.innerHTML = tableHtml;
        }

        function openPembangunanModal(item = null) {
            if (state.userRole !== 'admin') return;
            const modal = document.getElementById('pembangunanModal');
            const form = document.getElementById('pembangunanForm');
            const title = document.getElementById('pembangunanModalTitle');
            form.reset();
            document.getElementById('pembangunanId').value = '';

            if (item) {
                title.textContent = 'Edit Pembangunan';
                document.getElementById('pembangunanId').value = item.id;
                document.getElementById('pembangunanNama').value = item.nama_proyek;
                document.getElementById('pembangunanStatus').value = item.status;
                document.getElementById('pembangunanAnggaran').value = item.anggaran;
            } else {
                title.textContent = 'Tambah Pembangunan';
            }
            modal.classList.add('active');
        }

        function closePembangunanModal() {
            document.getElementById('pembangunanModal').classList.remove('active');
        }

        document.getElementById('pembangunanForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('pembangunanId').value;
            const data = {
                nama_proyek: document.getElementById('pembangunanNama').value,
                status: document.getElementById('pembangunanStatus').value,
                anggaran: parseFloat(document.getElementById('pembangunanAnggaran').value),
            };
            savePembangunan(data, id);
        });

        function savePembangunan(data, id) {
            if (state.userRole !== 'admin') return;
            if (id) {
                const index = state.pembangunanData.findIndex(item => item.id === id);
                if (index !== -1) {
                    const oldData = state.pembangunanData[index];
                    state.pembangunanData[index] = { ...oldData, ...data, tanggal: new Date().toISOString() };
                    addActivityLog('Pembangunan', 'UPDATE', id, `Mengubah data proyek: ${data.nama_proyek}`);
                }
            } else {
                const newId = generateId();
                const newData = { id: newId, ...data, tanggal: new Date().toISOString() };
                state.pembangunanData.push(newData);
                addActivityLog('Pembangunan', 'CREATE', newId, `Menambah proyek baru: ${data.nama_proyek}`);
            }
            saveState();
            renderPembangunanTable();
            closePembangunanModal();
            renderDashboard();
        }

        function editPembangunan(id) {
            if (state.userRole !== 'admin') return;
            const item = state.pembangunanData.find(item => item.id === id);
            if (item) {
                openPembangunanModal(item);
            }
        }

        // =======================================================
        // KEUANGAN
        // =======================================================

        function renderKeuanganTable() {
            const tableContainer = document.getElementById('keuangan-table-container');
            if (state.keuanganData.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Belum ada data keuangan.</p>';
                return;
            }
            
            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            state.keuanganData.forEach(item => {
                const amountClass = item.tipe === 'pemasukan' ? 'text-green-600' : 'text-red-600';
                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.tanggal)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">${item.tipe}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.deskripsi}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${amountClass}">Rp ${item.jumlah.toLocaleString('id-ID')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewDetails('keuangan', '${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2"><i class="fa-solid fa-eye"></i></button>
                            <button onclick="editKeuangan('${item.id}')" class="text-yellow-600 hover:text-yellow-900 mr-2 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-edit"></i></button>
                            <button onclick="deleteItem('keuangan', '${item.id}')" class="text-red-600 hover:text-red-900 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            tableContainer.innerHTML = tableHtml;
        }

        function openKeuanganModal(item = null) {
            if (state.userRole !== 'admin') return;
            const modal = document.getElementById('keuanganModal');
            const form = document.getElementById('keuanganForm');
            const title = document.getElementById('keuanganModalTitle');
            form.reset();
            document.getElementById('keuanganId').value = '';

            if (item) {
                title.textContent = 'Edit Transaksi';
                document.getElementById('keuanganId').value = item.id;
                document.getElementById('keuanganTipe').value = item.tipe;
                document.getElementById('keuanganDeskripsi').value = item.deskripsi;
                document.getElementById('keuanganJumlah').value = item.jumlah;
            } else {
                title.textContent = 'Tambah Transaksi';
            }
            modal.classList.add('active');
        }

        function closeKeuanganModal() {
            document.getElementById('keuanganModal').classList.remove('active');
        }

        document.getElementById('keuanganForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('keuanganId').value;
            const data = {
                tipe: document.getElementById('keuanganTipe').value,
                deskripsi: document.getElementById('keuanganDeskripsi').value,
                jumlah: parseFloat(document.getElementById('keuanganJumlah').value),
            };
            saveKeuangan(data, id);
        });

        function saveKeuangan(data, id) {
            if (state.userRole !== 'admin') return;
            if (id) {
                const index = state.keuanganData.findIndex(item => item.id === id);
                if (index !== -1) {
                    const oldData = state.keuanganData[index];
                    state.keuanganData[index] = { ...oldData, ...data, tanggal: new Date().toISOString() };
                    addActivityLog('Keuangan', 'UPDATE', id, `Mengubah transaksi: ${data.deskripsi}`);
                }
            } else {
                const newId = generateId();
                const newData = { id: newId, ...data, tanggal: new Date().toISOString() };
                state.keuanganData.push(newData);
                addActivityLog('Keuangan', 'CREATE', newId, `Menambah transaksi: ${data.deskripsi}`);
            }
            saveState();
            renderKeuanganTable();
            closeKeuanganModal();
            renderDashboard();
        }

        function editKeuangan(id) {
            if (state.userRole !== 'admin') return;
            const item = state.keuanganData.find(item => item.id === id);
            if (item) {
                openKeuanganModal(item);
            }
        }

        // =======================================================
        // BANSOS
        // =======================================================

        function renderBansosTable() {
            const tableContainer = document.getElementById('bansos-table-container');
            if (state.bansosData.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Belum ada data bantuan sosial.</p>';
                return;
            }
            
            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Penerima</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Bantuan</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            state.bansosData.forEach(item => {
                const recipient = state.pendudukData.find(p => p.id === item.recipientId);
                const recipientName = recipient ? recipient.nama : 'Tidak Ditemukan';
                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.tanggal)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${recipientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.jenis_bantuan}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.status}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewDetails('bansos', '${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2"><i class="fa-solid fa-eye"></i></button>
                            <button onclick="editBansos('${item.id}')" class="text-yellow-600 hover:text-yellow-900 mr-2 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-edit"></i></button>
                            <button onclick="deleteItem('bansos', '${item.id}')" class="text-red-600 hover:text-red-900 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            tableContainer.innerHTML = tableHtml;
        }

        function openBansosModal(item = null) {
            if (state.userRole !== 'admin') return;
            const modal = document.getElementById('bansosModal');
            const form = document.getElementById('bansosForm');
            const title = document.getElementById('bansosModalTitle');
            const penerimaSelect = document.getElementById('bansosNamaPenerima');
            penerimaSelect.innerHTML = '<option value="">Pilih Nama Penerima</option>';
            state.pendudukData.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.nama;
                penerimaSelect.appendChild(option);
            });
            form.reset();
            document.getElementById('bansosId').value = '';

            if (item) {
                title.textContent = 'Edit Bantuan';
                document.getElementById('bansosId').value = item.id;
                document.getElementById('bansosNamaPenerima').value = item.recipientId;
                document.getElementById('bansosJenis').value = item.jenis_bantuan;
                document.getElementById('bansosStatus').value = item.status;
            } else {
                title.textContent = 'Tambah Bantuan';
            }
            modal.classList.add('active');
        }

        function closeBansosModal() {
            document.getElementById('bansosModal').classList.remove('active');
        }

        document.getElementById('bansosForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('bansosId').value;
            const data = {
                recipientId: document.getElementById('bansosNamaPenerima').value,
                jenis_bantuan: document.getElementById('bansosJenis').value,
                status: document.getElementById('bansosStatus').value,
            };
            saveBansos(data, id);
        });

        function saveBansos(data, id) {
            if (state.userRole !== 'admin') return;
            const penerimaNama = state.pendudukData.find(p => p.id === data.recipientId)?.nama;
            if (id) {
                const index = state.bansosData.findIndex(item => item.id === id);
                if (index !== -1) {
                    const oldData = state.bansosData[index];
                    state.bansosData[index] = { ...oldData, ...data, tanggal: new Date().toISOString() };
                    addActivityLog('Bantuan Sosial', 'UPDATE', id, `Mengubah data bantuan untuk ${penerimaNama}`);
                }
            } else {
                const newId = generateId();
                const newData = { id: newId, ...data, tanggal: new Date().toISOString() };
                state.bansosData.push(newData);
                addActivityLog('Bantuan Sosial', 'CREATE', newId, `Menambah bantuan baru untuk ${penerimaNama}`);
            }
            saveState();
            renderBansosTable();
            closeBansosModal();
            renderDashboard();
        }

        function editBansos(id) {
            if (state.userRole !== 'admin') return;
            const item = state.bansosData.find(item => item.id === id);
            if (item) {
                openBansosModal(item);
            }
        }

        // =======================================================
        // PENGADUAN
        // =======================================================

        function renderPengaduanTable() {
            const tableContainer = document.getElementById('pengaduan-table-container');
            if (state.pengaduanData.length === 0) {
                tableContainer.innerHTML = '<p class="text-center text-gray-500 p-8">Belum ada data pengaduan.</p>';
                return;
            }

            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pelapor</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Judul</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            state.pengaduanData.forEach(item => {
                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(item.tanggal)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.nama_pelapor}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.judul}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.status}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="viewDetails('pengaduan', '${item.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2"><i class="fa-solid fa-eye"></i></button>
                            <button onclick="editPengaduan('${item.id}')" class="text-yellow-600 hover:text-yellow-900 mr-2 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-edit"></i></button>
                            <button onclick="deleteItem('pengaduan', '${item.id}')" class="text-red-600 hover:text-red-900 ${state.userRole !== 'admin' ? 'hidden' : ''}"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table>`;
            tableContainer.innerHTML = tableHtml;
        }

        function openPengaduanModal(item = null) {
            const modal = document.getElementById('pengaduanModal');
            const form = document.getElementById('pengaduanForm');
            const title = document.getElementById('pengaduanModalTitle');
            form.reset();
            document.getElementById('pengaduanId').value = '';

            if (item) {
                if (state.userRole !== 'admin') return;
                title.textContent = 'Edit Pengaduan';
                document.getElementById('pengaduanId').value = item.id;
                document.getElementById('pengaduanNamaPelapor').value = item.nama_pelapor;
                document.getElementById('pengaduanJudul').value = item.judul;
                document.getElementById('pengaduanDeskripsi').value = item.deskripsi;
                document.getElementById('pengaduanStatus').value = item.status;
            } else {
                title.textContent = 'Tambah Pengaduan';
            }
            modal.classList.add('active');
        }

        function closePengaduanModal() {
            document.getElementById('pengaduanModal').classList.remove('active');
        }

        document.getElementById('pengaduanForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const id = document.getElementById('pengaduanId').value;
            const data = {
                nama_pelapor: document.getElementById('pengaduanNamaPelapor').value,
                judul: document.getElementById('pengaduanJudul').value,
                deskripsi: document.getElementById('pengaduanDeskripsi').value,
                status: document.getElementById('pengaduanStatus').value,
            };
            savePengaduan(data, id);
        });

        function savePengaduan(data, id) {
            if (id && state.userRole !== 'admin') return;
            if (id) {
                const index = state.pengaduanData.findIndex(item => item.id === id);
                if (index !== -1) {
                    const oldData = state.pengaduanData[index];
                    state.pengaduanData[index] = { ...oldData, ...data, tanggal: new Date().toISOString() };
                    addActivityLog('Pengaduan', 'UPDATE', id, `Mengubah status pengaduan: ${data.judul}`);
                }
            } else {
                const newId = generateId();
                const newData = { id: newId, ...data, tanggal: new Date().toISOString() };
                state.pengaduanData.push(newData);
                addActivityLog('Pengaduan', 'CREATE', newId, `Menambah pengaduan baru: ${data.judul}`);
            }
            saveState();
            renderPengaduanTable();
            closePengaduanModal();
            renderDashboard();
        }

        function editPengaduan(id) {
            if (state.userRole !== 'admin') return;
            const item = state.pengaduanData.find(item => item.id === id);
            if (item) {
                openPengaduanModal(item);
            }
        }

        // =======================================================
        // ACTIVITY LOGS
        // =======================================================

        function renderActivityLogsTable(filteredLogs = null) {
            const tableBody = document.getElementById('activityLogsTableBody');
            tableBody.innerHTML = '';
            const logsToRender = filteredLogs || state.activityLogs;

            if (logsToRender.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500 py-8">Belum ada laporan aktivitas.</td></tr>';
                return;
            }

            logsToRender.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            logsToRender.forEach(log => {
                const statusClass = log.status === 'SUCCESS' ? 'text-green-600' : 'text-red-600';
                const formattedDate = formatDate(log.timestamp);

                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.user}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.module}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.action}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.recordId || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-xs">${log.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.ipAddress}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${statusClass}">${log.status}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            ${log.details ? `<button onclick="showLogDetails('${log.id}')" class="text-indigo-600 hover:text-indigo-900">Detail</button>` : ''}
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        function showLogDetails(id) {
            const log = state.activityLogs.find(l => l.id === id);
            if (log && log.details) {
                const modal = document.getElementById('logDetailModal');
                const content = document.getElementById('logDetailContent');
                content.textContent = JSON.stringify(log.details, null, 2);
                modal.classList.add('active');
            }
        }

        function closeLogDetailModal() {
            document.getElementById('logDetailModal').classList.remove('active');
        }

        function applyLogFilters() {
            const startDate = document.getElementById('logStartDate').value;
            const endDate = document.getElementById('logEndDate').value;
            const userFilter = document.getElementById('logUserFilter').value;
            const moduleFilter = document.getElementById('logModuleFilter').value;
            const actionTypeFilter = document.getElementById('logActionTypeFilter').value;
            const searchText = document.getElementById('logSearchText').value.toLowerCase();

            const filteredLogs = state.activityLogs.filter(log => {
                const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                const dateMatch = (!startDate || logDate >= startDate) && (!endDate || logDate <= endDate);
                const userMatch = !userFilter || log.user === userFilter;
                const moduleMatch = !moduleFilter || log.module === moduleFilter;
                const actionMatch = !actionTypeFilter || log.action === actionTypeFilter;
                const textMatch = !searchText ||
                    (log.description && log.description.toLowerCase().includes(searchText)) ||
                    (log.recordId && log.recordId.toLowerCase().includes(searchText));
                
                return dateMatch && userMatch && moduleMatch && actionMatch && textMatch;
            });

            renderActivityLogsTable(filteredLogs);
        }

        function exportActivityLogsToExcel() {
            const logsToExport = document.getElementById('activityLogsTableBody').querySelectorAll('tr');
            if (logsToExport.length === 0 || (logsToExport.length === 1 && logsToExport[0].textContent.includes('Belum ada laporan'))) {
                alert('Tidak ada data untuk diexport.');
                return;
            }

            const data = [];
            const header = ["Waktu", "Pengguna", "Modul", "Aksi", "ID Record", "Deskripsi", "IP Address", "Status"];
            data.push(header);

            logsToExport.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach((cell, index) => {
                    if (index < row.querySelectorAll('td').length - 1) {
                        rowData.push(cell.textContent.trim());
                    }
                });
                data.push(rowData);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Aktivitas");
            XLSX.writeFile(wb, "laporan_aktivitas_SIDeM.xlsx");
        }

        // =======================================================
        // GLOBAL FUNCTIONS
        // =======================================================

        let currentDeletion = null;

        function openConfirmationModal(message, callback) {
            document.getElementById('confirmationMessage').innerHTML = message;
            document.getElementById('confirmationModal').classList.add('active');
            currentDeletion = callback;
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('active');
            currentDeletion = null;
        }

        function performDeletion() {
            if (currentDeletion) {
                currentDeletion();
            }
            closeConfirmationModal();
        }

        function deleteItem(module, id) {
            if (state.userRole !== 'admin') return;

            const deletionMap = {
                'penduduk': () => {
                    state.pendudukData = state.pendudukData.filter(item => item.id !== id);
                    renderPendudukTable();
                    addActivityLog('Penduduk', 'DELETE', id, `Menghapus data penduduk dengan ID ${id}`);
                },
                'aset': () => {
                    state.asetData = state.asetData.filter(item => item.id !== id);
                    renderAsetTable();
                    addActivityLog('Aset Desa', 'DELETE', id, `Menghapus data aset dengan ID ${id}`);
                },
                'pembangunan': () => {
                    state.pembangunanData = state.pembangunanData.filter(item => item.id !== id);
                    renderPembangunanTable();
                    addActivityLog('Pembangunan', 'DELETE', id, `Menghapus data proyek pembangunan dengan ID ${id}`);
                },
                'keuangan': () => {
                    state.keuanganData = state.keuanganData.filter(item => item.id !== id);
                    renderKeuanganTable();
                    renderDashboard();
                    addActivityLog('Keuangan', 'DELETE', id, `Menghapus data transaksi keuangan dengan ID ${id}`);
                },
                'bansos': () => {
                    state.bansosData = state.bansosData.filter(item => item.id !== id);
                    renderBansosTable();
                    addActivityLog('Bantuan Sosial', 'DELETE', id, `Menghapus data bantuan sosial dengan ID ${id}`);
                },
                'pengaduan': () => {
                    state.pengaduanData = state.pengaduanData.filter(item => item.id !== id);
                    renderPengaduanTable();
                    renderDashboard();
                    addActivityLog('Pengaduan', 'DELETE', id, `Menghapus data pengaduan dengan ID ${id}`);
                }
            };
            
            const item = state[`${module}Data`].find(i => i.id === id);
            const itemName = item?.nama || item?.nama_aset || item?.nama_proyek || item?.deskripsi || item?.judul || 'item';
            
            openConfirmationModal(`Apakah Anda yakin ingin menghapus "${itemName}"?`, () => {
                if (deletionMap[module]) {
                    deletionMap[module]();
                    saveState();
                }
            });
        }

        function viewDetails(module, id) {
            const dataMap = {
                'penduduk': state.pendudukData,
                'aset': state.asetData,
                'pembangunan': state.pembangunanData,
                'keuangan': state.keuanganData,
                'bansos': state.bansosData,
                'pengaduan': state.pengaduanData,
            };
            
            const item = dataMap[module].find(i => i.id === id);
            if (item) {
                let details = '';
                for (const key in item) {
                    let value = item[key];
                    if (key === 'tanggal') {
                        value = formatDate(value);
                    } else if (key === 'jumlah' || key === 'anggaran') {
                        value = `Rp ${value.toLocaleString('id-ID')}`;
                    } else if (key === 'recipientId') {
                         value = state.pendudukData.find(p => p.id === value)?.nama || 'Tidak Ditemukan';
                    }
                    details += `<span class="font-bold">${capitalize(key.replace(/_/g, ' '))}:</span> ${value}<br>`;
                }
                openConfirmationModal(details, () => { /* no-op */ });
                document.getElementById('confirmationModal').querySelector('button.bg-red-600').classList.add('hidden');
                document.getElementById('confirmationModal').querySelector('button.bg-gray-200').textContent = 'Tutup';
            }
            addActivityLog(capitalize(module), 'VIEW', id, `Melihat detail ${module} dengan ID ${id}`);
        }

        // =======================================================
        // INITIALIZATION
        // =======================================================

        document.addEventListener('DOMContentLoaded', () => {
            cleanUpOldLogs();
            updateRole('guest');
            changeView('dashboard');
            addActivityLog('Sistem', 'INITIAL_LOAD', null, 'Aplikasi dimuat');
        });

          // --- Bagian 1: Menonaktifkan Klik Kanan ---
        document.addEventListener('contextmenu', event => event.preventDefault());

        // --- Bagian 2: Mempersulit Akses Developer Tools ---
        (function() {
            function blockDevTools() {
                // Ini akan terus memicu debugger saat DevTools terbuka
                // dan memaksa tab "Sources" atau "Debugger" untuk aktif.
                // Hal ini sangat mengganggu, gunakan dengan hati-hati!
                while (true) {
                    debugger;
                }
            }

            let devToolsAreOpen = false;
            // Ambang batas untuk mendeteksi perubahan ukuran jendela
            // Jika ada perbedaan ukuran yang signifikan, diasumsikan DevTools terbuka.
            const threshold = 160;

            function checkAndBlock() {
                if (window.outerWidth - window.innerWidth > threshold ||
                    window.outerHeight - window.innerHeight > threshold) {
                    if (!devToolsAreOpen) {
                        devToolsAreOpen = true;
                        // Pemicu debugger hanya jika DevTools baru saja terdeteksi terbuka.
                        // Ini mencegah debugger berjalan terus-menerus tanpa alasan.
                        blockDevTools();
                    }
                } else {
                    devToolsAreOpen = false;
                }
            }

            // Jalankan pengecekan saat halaman dimuat dan saat jendela diubah ukurannya
            window.addEventListener('load', checkAndBlock);
            window.addEventListener('resize', checkAndBlock);

            // Mendeteksi dan mencegah shortcut keyboard umum untuk Developer Tools dan View Source
            document.addEventListener('keydown', function(e) {
                // F12 key (umum untuk membuka DevTools)
                if (e.key === "F12") {
                    e.preventDefault();
                    // Opsional: Anda bisa menampilkan pesan atau melakukan tindakan lain di sini
                    // alert("Akses Developer Tools dibatasi.");
                }
                // Ctrl+Shift+I atau Cmd+Option+I (untuk Inspect Element)
                if ((e.ctrlKey && e.shiftKey && e.key === 'I') || (e.metaKey && e.altKey && e.key === 'I')) {
                    e.preventDefault();
                }
                // Ctrl+Shift+J atau Cmd+Option+J (untuk Console)
                if ((e.ctrlKey && e.shiftKey && e.key === 'J') || (e.metaKey && e.altKey && e.key === 'J')) {
                    e.preventDefault();
                }
                // Ctrl+U atau Cmd+U (untuk View Page Source)
                if ((e.ctrlKey && e.key === 'U') || (e.metaKey && e.key === 'U')) {
                    e.preventDefault();
                }
            });
        })();
    </script>
</body>

</html>
